# מצב עבודה Offline - תיעוד

## סקירה כללית

הפרויקט תומך במצב **Offline-First** - כל הנתונים נשמרים ב-localStorage ומסתנכרנים עם Firebase כשיש חיבור לאינטרנט.

## אינדיקטורים חזותיים

### 🟢 סטטוס אונליין/אופליין
- **בפינה הימנית העליונה**: אינדיקטור שמציג אם המכשיר מחובר לרשת
  - 🟢 ירוק = מחובר לרשת
  - 🔴 אדום = לא מחובר לרשת
  - מופיע רק כש-offline או במעבר בין המצבים

### 📊 זמן סנכרון אחרון
- **בפאנל העריכה** (כפתור ההגדרות):
  - **"סנכרון אחרון"** - מציג מתי בפעם האחרונה המכשיר היה מחובר לרשת וסינכרן נתונים
  - נקודה מהבהבת:
    - 🟢 ירוקה = מחובר עכשיו
    - 🔴 אדומה = לא מחובר
  - ⚠️ אזהרה צהובה - מופיעה כשאין חיבור לרשת

## איך זה עובד?

### 1. קריאת נתונים (Load)
- **מיידי**: כשהאפליקציה נטענת, הנתונים נקראים מ-localStorage (מהר מאוד!)
- **ללא תלות ברשת**: עובד גם אם אין חיבור לאינטרנט
- הנתונים מוצגים מיד למשתמש

### 2. שמירת נתונים (Save)
כשמשתמש משנה משהו (מוסיף תפילה, משנה הגדרות וכו'):

1. **שלב 1 - שמירה מיידית ל-localStorage**
   - הנתונים נשמרים מיידית במחשב
   - המשתמש רואה את השינוי תוך שבריר שניה
   - עובד גם אם אין חיבור לרשת!

2. **שלב 2 - סנכרון לענן (רקע)**
   - בד בבד, מתבצע ניסיון לשמור ב-Firebase
   - אם יש חיבור - הנתונים נשמרים גם בענן
   - אם אין חיבור - השמירה נכשלת בשקט, הנתונים נשארים ב-localStorage

### 3. סנכרון מהענן
- כשיש חיבור לאינטרנט, Firebase מאזין לשינויים
- אם נתונים השתנו בענן (מהמחשב אחר), הם מתעדכנים אוטומטית
- השינויים גם נשמרים ב-localStorage

## מה קורה במצבים שונים?

### ✅ מחובר לרשת
- הכל עובד חלק
- שינויים נשמרים ב-localStorage **וגם** ב-Firebase
- אם מישהו משנה מהמחשב אחר, השינויים מסתנכרנים

### 🔌 לא מחובר לרשת (Offline)
- **הכל עובד רגיל!**
- שינויים נשמרים ב-localStorage
- ניסיון שמירה ל-Firebase נכשל בשקט (אין הודעת שגיאה)
- כשהרשת תחזור, אפשר לסנכרן ידנית

### 🔄 מחדש הפעלה (Restart)
- **הכל נטען מ-localStorage**
- הנתונים האחרונים מופיעים מיד
- לא צריך רשת כדי להתחיל לעבוד!

### ⚠️ מחיקת localStorage
- אם localStorage נמחק (ניקוי דפדפן), הנתונים יחזרו מ-Firebase
- אם גם Firebase ריק, הנתונים ברירת המחדל יוצגו

## קבצים רלוונטיים

### [src/utils/offlineStorage.ts](src/utils/offlineStorage.ts)
מכיל את הלוגיקה הכללית של offline storage:
- `createOfflineStorage()` - יוצר storage hybrid
- `loadFromLocal()` - טוען מ-localStorage
- `saveToLocal()` - שומר ל-localStorage
- `syncToFirebase()` - מסנכרן לענן
- `setupFirebaseListener()` - מאזין לשינויים מהענן

### Hooks שמשתמשים ב-offline storage:
- [src/hooks/usePrayerTimes.ts](src/hooks/usePrayerTimes.ts) - אירועים/תפילות
- [src/hooks/useColumns.ts](src/hooks/useColumns.ts) - עמודות
- [src/hooks/useBoardSettings.ts](src/hooks/useBoardSettings.ts) - הגדרות

## יתרונות הגישה

1. **מהירות** - טעינה מיידית ללא המתנה לשרת
2. **אמינות** - עובד גם כשאין רשת
3. **גיבוי אוטומטי** - הנתונים תמיד שמורים במקום
4. **סנכרון חלק** - כשיש רשת, הכל מסתנכרן אוטומטית

## טיפים

### איך לבדוק את מצב ה-offline?
1. פתח את ה-DevTools (F12)
2. Network tab → Throttling → Offline
3. נסה לשנות דברים - הכל אמור לעבוד!
4. חזור ל-Online - השינויים יסתנכרנו

### איך לראות את localStorage?
1. פתח DevTools (F12)
2. Application tab → Local Storage
3. תראה:
   - `boardEvents` - תפילות/אירועים
   - `boardColumns` - עמודות
   - `boardSettings` - הגדרות

### איך לאפס הכל?
```javascript
// בקונסול של הדפדפן:
localStorage.clear()
location.reload()
```

## פתרון בעיות

### "הנתונים לא מסתנכרנים לענן"
- בדוק שיש חיבור לאינטרנט
- בדוק ב-Console אם יש שגיאות Firebase
- וודא שהמשתמש מחובר (logged in)

### "השינויים נעלמו אחרי ריסטרט"
- בדוק אם localStorage לא נמחק (ניקוי דפדפן)
- בדוק אם הדפדפן במצב Incognito (לא שומר localStorage)

### "הנתונים שונים בין מחשבים"
- וודא ששני המחשבים מחוברים לאינטרנט
- וודא שמשתמש עם אותו חשבון (userId)
- רענן את הדף (F5) כדי לסנכרן
